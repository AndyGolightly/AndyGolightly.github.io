<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>lecture3</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://samfearn.github.io/latex.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script type="text/x-mathjax-config">
  	MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "ams"} } });
  	// I need to wait until MathJax has finished before running the numbering script
  	MathJax.Hub.Register.StartupHook("End",function(){doNumbering()});
  </script>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#hierarchical-data-structures">Hierarchical data structures</a></li>
</ul>
</nav>
<section id="hierarchical-data-structures" class="level1 unnumbered">
<h1 class="unnumbered">Hierarchical data structures</h1>
<section id="motivation-and-basic-terminology" class="level3 unnumbered">
<h3 class="unnumbered">Motivation and basic terminology</h3>
<p>Social research often involves investigating the relationship between individuals and the social contexts in which they live, work etc. We expect that individuals are influenced by the groups to which they belong, and that groups are influenced by the individuals therein.</p>
</section>
<section id="hierarchical-data-structures-1" class="level3 unnumbered">
<h3 class="unnumbered">Hierarchical data structures</h3>
<p>We conceptualise the above via a <em>hierarchical system</em> in which individuals and groups represent different <em>levels</em> of the hierarchy. For example, in an education setting we might think of a population of schools, classes within schools and pupils within these classes. This is an example of a <em>three level</em> hierarchical structure with pupils <em>nested</em> in classes, and classes <em>nested</em> in schools.</p>
</section>
<section id="levels-and-variables" class="level3 unnumbered">
<h3 class="unnumbered">Levels and variables</h3>
<p><em>Variables</em> are <em>attributes of levels</em>. Usually, a variable can be clearly allocated to a certain level; i.e. the level at which it is measured. For example, gender or age would be measured at pupil level. Class size would be measured at class level.School type (faith school, free school, academy,…) would be measured at school level.</p>
</section>
<section id="the-need-for-multilevel-models" class="level3 unnumbered">
<h3 class="unnumbered">The need for multilevel models</h3>
<p>We expect similarities of lower-level-units belonging to the same upper-level-items which causes correlation between the units. Statistical models that ignore these correlations can lead to analyses that give incorrect conclusions.</p>
<p>For example, ignoring correlation can lead to smaller standard errors of test statistics which may lead to effects incorrectly labelled as “significant”.</p>
<p>The plots below show the fits of two different regression models which</p>
<ul>
<li><p>(top) assumes that all lower-level-units are from the same group (ignores group structure),</p></li>
<li><p>(bottom) takes into account the presence of group structure.</p></li>
</ul>
<p> </p>
<div class="center">
<p><img src="../graphics2/lect3a.png" title="fig:" id="fig:fig1" style="width:7cm;height:6.5cm" alt="Multilevel model motivation." /><br />
<img src="../graphics2/lect3b.png" title="fig:" id="fig:fig1" style="width:7cm;height:6.5cm" alt="Multilevel model motivation." /></p>
</div>
<div class="center">
<p><strong>Figure 1:</strong> Multilevel model motivation.</p>
</div>
<p> </p>
</section>
<section id="caveats-from-historical-approaches" class="level3 unnumbered">
<h3 class="unnumbered">Caveats from historical approaches</h3>
<p>Incorrect approaches fr dealing with multilevel structures:</p>
<ul>
<li><p><strong>Disaggregation</strong>: All units at the lower level receive the value of a variable at the higher level at which they were measured, resulting in contextual variables (for example, each pupil gets associated to the size of their class). Lower-level units treated as independent.</p></li>
<li><p><strong>Aggregation</strong>: Operating at a higher level, one takes averages or other aggregated measures of lower-level units to use as predictor at that level, resulting in structural variables. For instance, a class may be given an attribute “mean intelligence”.</p></li>
</ul>
<p>The latter can lead to an <em>ecological fallacy</em>. This occurs when inferences about the nature of individuals are deduced from inferences about the group to which those individuals belong.</p>
<p> </p>
<p><strong>Example 1</strong>: Consider the the following height data (in cm) from a single group of individuals: <span class="math display">\[153, 160, 175, 176, 180, 195, 210.\]</span> What is the mean? Suppose that the population mean is 177. Can we infer that a random individual selected from the group is more likely to be taller than the mean of the general population?</p>
<p> </p>
<p><strong>Example 2 (Robinson effect)</strong>: Robinson (1950) highlighted that the (at the time) commonplace practice of</p>
<ul>
<li><p>aggregating individual-level data to group- or class-means,</p></li>
<li><p>estimating correlations, effects, etc on the upper (group) level,</p></li>
<li><p>drawing from these conclusions for individuals on the lower level</p></li>
</ul>
<p>is fundamentally flawed (since group-level variables may act as moderators).</p>
<p>Robinson computed the illiteracy rate and the proportion of the population born outside the US for each state and for the District of Columbia, as of the 1930 census. He found a negative correlation of <span class="math inline">\(-\)</span>0.53. However, when individuals are considered, the correlation between illiteracy and nativity was <span class="math inline">\(+\)</span>0.12. Can you think of an explanation for this?</p>
</section>
<section id="application-student-popularity-data" class="level3 unnumbered">
<h3 class="unnumbered">Application: student popularity data</h3>
<p>We will consider data on student popularity taken from Hox et al. (2018).</p>
<section id="the-data-set" class="level4 unnumbered">
<h4 class="unnumbered">The data set</h4>
<p>We have:</p>
<ul>
<li><p>Lower level (level 1): pupils</p></li>
<li><p>Upper level (level 2): classes</p></li>
</ul>
<p>The data are from <span class="math inline">\(J=100\)</span> classes with <span class="math inline">\(n_j\)</span> pupils in each class and <span class="math inline">\(\sum_{j=1}^{100} n_j=2000\)</span>. The response/outcome variable is at the pupil level and is a popularity score measured on a continuous scale ranging from 0 (very unpopular) to 10 (very popular).</p>
<p>We further have explanatory variables on pupil level:</p>
<ul>
<li><p>Pupil extraversion (<span class="math inline">\(x_1\)</span>), measured on a self-rating 10-point scale from 1 (min) to 10 (max)</p></li>
<li><p>Pupil gender (<span class="math inline">\(x_2\)</span>), with values <span class="math inline">\(x_2=0\)</span> (boy) and <span class="math inline">\(x_2=1\)</span> (girl)</p></li>
</ul>
<p>and explanatory variable on class level:</p>
<ul>
<li><p>Teacher experience (<span class="math inline">\(z\)</span>), in years, ranging from 2-25, integer-valued.</p></li>
</ul>
</section>
<section id="naive-analyses" class="level4 unnumbered">
<h4 class="unnumbered">Naive analyses</h4>
<p>Let’s ignore the two-level structure, gender, and teacher experience for now, and consider a single covariate <span class="math inline">\(x_1=\)</span> extraversion, denoted by <span class="math inline">\(x\)</span> for simplicity.</p>
<p>We then fit the model <span class="math display">\[y_i=a + b x_i + \epsilon_i, \qquad i=1,2,\ldots,2000\]</span> where the <span class="math inline">\(\epsilon_i\)</span> are independent Gaussian error terms (with mean zero and variance <span class="math inline">\(\sigma^2\)</span>. Fitting the model in R gives the following output:</p>
<div class="sourceCode" id="cb1" data-language="R"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">##              Estimate  Std. Error t value  Pr(&gt;|t|)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="co">## (Intercept)  3.2728356 0.12473523 26.23826 1.237371e-130</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co">## extraversion 0.3458513 0.02324748 14.87694 1.481801e-47</span></span></code></pre></div>
<p>for which the fitted regression line is: <span class="math display">\[y=3.27+0.35x.\]</span></p>
<div class="center">
<p><img src="../graphics2/lect3c.png" title="fig:" id="fig:fig2" style="width:7cm;height:6.5cm" alt="Top: data and fitted regression line with standard error band (ignores class structure. Bottom: data (jittered for better visibility) separate regression lines for each class." /><br />
<img src="../graphics2/lect3d.png" title="fig:" id="fig:fig2" style="width:8cm;height:6.5cm" alt="Top: data and fitted regression line with standard error band (ignores class structure. Bottom: data (jittered for better visibility) separate regression lines for each class." /></p>
</div>
<div class="center">
<p><strong>Figure 2:</strong> Top: data and fitted regression line with standard error band (ignores class structure. Bottom: data (jittered for better visibility) separate regression lines for each class.</p>
</div>
<p> </p>
<div class="center">
<p><img src="../graphics2/lect3e.png" title="fig:" id="fig:fig3" style="width:7cm;height:6.5cm" alt="Top: histograms of class-wise intercepts. Bottom: histograms of class-wise slopes." /><br />
<img src="../graphics2/lect3f.png" title="fig:" id="fig:fig3" style="width:7cm;height:6.5cm" alt="Top: histograms of class-wise intercepts. Bottom: histograms of class-wise slopes." /></p>
</div>
<div class="center">
<p><strong>Figure 3:</strong> Top: histograms of class-wise intercepts. Bottom: histograms of class-wise slopes.</p>
</div>
<p>Figure 2 (top) shows the fitted regression line for the regression model that ignores group (class structure). Figure 2 (bottom) fits a separate regression model to each class. That is, for class <span class="math inline">\(j\)</span>, we fit the model <span class="math display">\[y_{ij}=a_{j} + b_{j} x_{ij} + \epsilon_{ij}, \qquad i=1,2,\ldots,n_j.\]</span> The resulting intercept estimates <span class="math inline">\(\hat{a}_{j}\)</span> and slope estimates <span class="math inline">\(\hat{b}_{j}\)</span> are plotted as histograms in Figure 3.</p>
<p><em>Instead of fitting 100 separate regression models, we would like to explain within class variation using a single model.</em></p>
</section>
</section>
</section>
<script>
function doNumbering() {
	// The syntax to read the structured data from the yaml is horrible, template literals fix the problem but probably aren't widely supported enough. Escaping line breaks is browser dependant. I don't know if there's a better way?
	// Note that the data from the yaml file is manipulated into an array, and then parsed back into strings later, but I didn't want to deal with the pandoc templating syntax longer than necessary.
	var supportedEnvsArrayString = ' .definition;;; .theorem;;; .lemma;;; .example;;; .exampleqed;;; .proposition;;; .remark;;; .corollary;;; .exercise;;; .question';
	var supportedEnvsArray = supportedEnvsArrayString.split("|||");
	supportedEnvsArray = supportedEnvsArray.map(inner => inner.split(";;;"));
	var numberWithin = '1';
	var counterOffset = '';
	var subcounterOffset = '';
	var problemCounter = '';
	const partLabels = 'abcdefghijklmnopqrstuvwxyz'.split('');
	
	// counterOffset may be negative, and by default if specified on the command line this gets string concatenated with the default given in the yaml config and this then causes a problem. Can be fixed by removing the default in the config file and converting to an int, but this causes a NaN error if no value is suplied on the command line, so if NaN set to 0.
	counterOffset = parseInt(counterOffset);
	if (isNaN(counterOffset)) {
		counterOffset = 0;
	}
	
	subcounterOffset = parseInt(subcounterOffset);
	if (isNaN(subcounterOffset)) {
		subcounterOffset = 0;
	}
	
	problemCounter = parseInt(problemCounter);
	if (isNaN(problemCounter)) {
		problemCounter = 1;
	}
	
	function sanitiseSelector(selector) {
		// tex labels often have colons in which need escaping. There may be other escaping needed here. Unfortunately neither encodeURI nor encodeURIComponent do what I need, so use regex to do the escaping manually.
		var sanitised = selector.replace(/\:/g,"\\\:");
		sanitised = sanitised.replace(/(^[\d])/,"\\3$1 ");
		sanitised = sanitised.replace(/\//g,"\\\/");
		return sanitised
	}
	
	function labelLinks() {
		var refs = document.querySelectorAll("a[data-reference-type=ref]")
		for (ref of refs) {
			// Escape colons (or other) from the link title.
			var ref_label = sanitiseSelector(ref.getAttribute("data-reference"));
			// Hopefully ref is a reference to a div or a section, which should have the associated id. If so, we just need the data-number from the relevant DOM item.
			var ref_to = document.querySelector("#"+ref_label);
			if (ref_to !== null) {
				var ref_number = ref_to.getAttribute("data-number");
			} else {
				// If ref is being used for an equation, then we need to try to parse the mathjax divs. This is fragile, but try to find the span which corresponds to the equation number we need.
				try {
					var mathjax_ref = "#mjx-eqn-"+ref_label;
					ref_to = document.querySelector(mathjax_ref);
					// Since this is a ref, we don't want the parens to be returned, so find the equation number and strip the parens.
					var ref_number = ref_to.querySelector(".mjx-char").innerHTML.replace(/[()]/g,"");
					ref.setAttribute("href",mathjax_ref);
				}
				// If we can't find a place to link to, just indicate a missing link.
				catch (err){
					var ref_number = "???"
				}
			}
			ref.innerHTML = ref_number;
		};
	}
	
	function numberEnvs() {
		for (var levelSpec = 0; levelSpec <= numberWithin; levelSpec++) {
			var reqLevels = document.querySelectorAll(".level"+levelSpec);
			for (var level of reqLevels) {
				levelCount = level.getAttribute("data-number");
				levelCount = String(parseFloat(levelCount)+(counterOffset));
				levelCount = levelCount+(("."+subcounterOffset).repeat(numberWithin-levelSpec));
				for (var counter of supportedEnvsArray) {
					var envCount = 1;
					var envs = level.querySelectorAll(counter.join(", "));
					for (var env of envs) {
						env.setAttribute("data-number",levelCount+"."+envCount);
						envCount += 1;
					}
				}
			}
		}
	}
	
	function numberFigs() {
		// Figures should either be in a figure environment, or a table with image class imageTable thanks to the tableCaps filter.
		figs = document.querySelectorAll("figure, .imageTable");
		var fig_no = 1
		for (var fig of figs) {
			var cap
			// For figures, we want to move the id to the figure, and set the data-number on both the figure and the figcaption
			if (fig.nodeName == "FIGURE") {
				cap = fig.querySelector("figcaption");
				var img = fig.querySelector("img, embed")
				if (img) {
					var img_id = img.getAttribute("id");
					fig.setAttribute("id",img_id);
					img.removeAttribute("id");
				}
			// for tables (which must be .imageTable due to the querySelector above), we want to set the data-number on the table and the caption
			} else if (fig.nodeName == "TABLE") {
				cap = fig.querySelector("caption");
			}
			cap.setAttribute("data-number",fig_no);
			fig.setAttribute("data-number",fig_no);
			fig_no += 1;
		}
	}
	
	function numberGlobals() {
		// This function numbers any environments that just use a global counter, such as a problem number on a problems sheet, where there are no sections to number with respect to.
		probsols = document.querySelectorAll(".problem, .solution");
		var prob_no = problemCounter;
		var partNo = 0;
		for (var probsol of probsols) {
			if (probsol.className == "problem"){
				prob_no +=1;
				partNo = 0;
				probsol.setAttribute("data-number",prob_no);
			}
			else {
				if (probsol.parentNode.nodeName == "LI") {
					var partLabel = partLabels[partNo];
					probsol.setAttribute("data-number",prob_no.toString()+partLabel);
					partNo +=1;
				}
				else{
					probsol.setAttribute("data-number",prob_no);
				}
			}
			
		}
		// sols = document.querySelectorAll(".solution");
// 		var sol_no = problemCounter;
// 		for (var sol of sols) {
// 			sol.setAttribute("data-number",sol_no);
// 			sol_no +=1
// 		}
	}
	
	// labelLinks() should occur last, so that the data-numbers have been correctly set first.
	numberEnvs();
	numberFigs();
	numberGlobals();
	labelLinks();
}
</script><script>
	var imageDir = ''
	imgs = document.querySelectorAll("img");
	for (var img of imgs) {
		imgsrc = img.getAttribute("src");
		img.setAttribute("src",imageDir.concat(imgsrc));
	}
</script></body>
</html>
